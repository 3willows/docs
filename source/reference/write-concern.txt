.. _write-operations-write-concern:
.. _write-concern-operation:
.. _write-concern-internals:
.. _write-concern:

=============
Write Concern
=============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol


Write concern describes the level of acknowledgement requested from
MongoDB for write operations to a standalone :binary:`~bin.mongod` or to
:doc:`replica sets </replication>` or to
:doc:`sharded clusters </sharding>`. In
sharded clusters, :binary:`~bin.mongos` instances will pass the write
concern on to the shards.

.. versionchanged:: 2.6
   A new protocol for :ref:`write operations
   <rel-notes-write-operations>` integrates write concerns with the
   write operations and eliminates the need to call the
   :dbcommand:`getLastError` command. Previous versions required a
   :dbcommand:`getLastError` command immediately after a write
   operation to specify the write concern.

Write Concern Specification
---------------------------

Write concern can include the following fields:

.. code-block:: javascript

   { w: <value>, j: <boolean>, wtimeout: <number> }

- the :ref:`w <wc-w>` option to request acknowledgment that the write
  operation has propagated to a specified number of :binary:`~bin.mongod`
  instances or to :binary:`~bin.mongod` instances with specified tags.

- the :ref:`j <wc-j>` option to request acknowledgement that the write
  operation has been written to the journal, and

- :ref:`wtimeout <wc-wtimeout>` option to specify a time limit to
  prevent write operations from blocking indefinitely.

.. _wc-w:

``w`` Option
~~~~~~~~~~~~

The ``w`` option requests acknowledgement that the write operation has
propagated to a specified number of :binary:`~bin.mongod` instances or to
:binary:`~bin.mongod` instances with specified tags.

Using the ``w`` option, the following ``w: <value>`` write concerns are
available:


.. list-table::
   :header-rows: 1
   :widths: 25 75

   * - Value
     - Description

   * - .. writeconcern:: <number>

     - Requests acknowledgement that the write operation has propagated
       to the specified number of :binary:`~bin.mongod` instances. For
       example:

       ``w: 1``
         Requests acknowledgement that the write operation has
         propagated to the standalone :binary:`~bin.mongod` or the primary
         in a replica set. ``w: 1`` is the default write concern for
         MongoDB.

       ``w: 0``
         Requests no acknowledgment of the write operation. However, ``w:
         0`` may return information about socket exceptions and
         networking errors to the application.

         If you specify ``w: 0`` but include :ref:`j: true <wc-j>`, the
         :ref:`j: true <wc-j>` prevails to request acknowledgement from
         the standalone :binary:`~bin.mongod` or the primary of a replica
         set.

       Numbers greater than 1 are valid only for replica sets to
       request acknowledgement from specified number of members,
       including the primary.

   * - .. writeconcern:: "majority"

     - Requests acknowledgment that write operations have propagated to
       the :ref:`calculated majority <calculating-majority-count>` of the
       data-bearing voting members (i.e. primary and secondaries with
       :rsconf:`members[n].votes` greater than ``0``).

       For example, consider a replica set with 3 voting members,
       Primary-Secondary-Secondary (P-S-S). For this replica set,
       :ref:`calculated majority <calculating-majority-count>` is two, and
       the write must propagate to the primary and one secondary to
       acknowledge the write concern to the client.

       .. note:: 

          :ref:`Hidden <replica-set-hidden-members>`,
          :ref:`delayed <replica-set-delayed-members>`,
          and :ref:`priority 0 <replica-set-secondary-only-members>`
          members with :rsconf:`members[n].votes` greater than ``0``
          can acknowledge :writeconcern:`"majority"` write operations.

          Delayed secondaries can return write acknowledgment no earlier
          than the configured :rsconf:`~members[n].slaveDelay`. 

       Starting in version 3.2.6
          For replica sets using :rsconf:`protocolVersion: 1
          <protocolVersion>`, :writeconcern:`w: "majority"
          <"majority">` may imply :ref:`j: true <wc-j>` if journaling
          is enabled. See :rsconf:`writeConcernMajorityJournalDefault`.


       In earlier 3.2 versions, 
          :writeconcern:`w: "majority" <"majority">` implies :ref:`j:
          true <wc-j>` if journaling is enabled. With earlier versions
          of MongoDB, :writeconcern:`w: "majority" <"majority">` does
          not imply journaling.

       After the write operation returns with a :writeconcern:`w:
       "majority" <"majority">` acknowledgement to the client, the
       client can read the result of that write with a
       :readconcern:`"majority"` readConcern.

   * - .. writeconcern:: <tag set>

     - Requests acknowledgement that the write operations have
       propagated to a replica set member with the specified :ref:`tag
       <replica-set-configuration-tag-sets>`.

.. _wc-j:

``j`` Option
~~~~~~~~~~~~

The ``j`` option requests acknowledgement from MongoDB that the write
operation has been written to the :doc:`journal </core/journaling>`.

.. list-table::
   :widths: 25 75

   * - .. writeconcern:: j

     - Requests acknowledgement that the :binary:`~bin.mongod` instances, as
       specified in the :ref:`w: \<value\> <wc-w>`, have written to the
       on-disk journal. ``j: true`` does not by itself guarantee that
       the write will not be rolled back due to replica set primary
       failover.

       .. versionchanged:: 3.2

          .. include:: /includes/note-write-concern-journaled-replication.rst

.. versionchanged:: 2.6
   Specifying a write concern that includes ``j: true`` to
   a :binary:`~bin.mongod` or :binary:`~bin.mongos` running with
   ``--nojournal`` option produces an error. Previous versions would
   ignore the ``j: true``.

.. _wc-wtimeout:

``wtimeout``
~~~~~~~~~~~~

This option specifies a time limit, in milliseconds, for the write
concern. ``wtimeout`` is only applicable for ``w`` values greater than
``1``.

``wtimeout`` causes write operations to return with an error
after the specified limit, even if the required write concern will
eventually succeed. When these write operations return,
MongoDB **does not** undo successful data modifications performed
before the write concern exceeded the ``wtimeout`` time limit.

If you do not specify the ``wtimeout`` option and the level of write
concern is unachievable, the write operation will block indefinitely.
Specifying a ``wtimeout`` value of ``0`` is equivalent to a write
concern without the ``wtimeout`` option.

Acknowlegement Behavior
-----------------------

- Standalone mongod instances acknowledge write operations after
  applying the write in memory unless ``j:true``.


- .. versionchanged:: 3.2.6

     For replica sets using :rsconf:`protocolVersion: 1
     <protocolVersion>`, :writeconcern:`w: "majority" <"majority">` may
     imply :ref:`j: true <wc-j>` if journaling is enabled. The
     :rsconf:`writeConcernMajorityJournalDefault` replica set
     configuration setting determines the behavior.

     In 3.2-versions earlier than 3.2.6, :writeconcern:`w: "majority"
     <"majority">` implies :ref:`j: true <wc-j>` if journaling is
     enabled. With earlier versions of MongoDB, :writeconcern:`w:
     "majority" <"majority">` does not imply journaling.

.. _calculating-majority-count:

Calculating Majority for Write Concern
---------------------------------------

The majority for write concern :writeconcern:`"majority"` is calculated
as the smaller of the following values:

- the majority of *all* voting members (including arbiters) vs.

- the number of all **data-bearing** voting members.

.. warning::

   In cases where the calculated majority number is equal to the number
   of all **data-bearing** voting members (such as with a 3-member
   Primary-Secondary-Arbiter deployment), write concern
   :writeconcern:`"majority"` may time out or never be acknowledged if
   a data bearing voting member is down or unreachable. If possible,
   use a data-bearing voting member instead of an arbiter.

For example, consider:

- A replica set with 3 voting members, Primary-Secondary-Secondary
  (P-S-S):

  - The majority of all voting members is 2.

  - The number of all data-bearing voting members is 3.

  | The calculated majority is 2, the minimum of 2 and 3. The write
    must propagate to the primary and one of the secondaries to
    acknowledge the write concern :writeconcern:`"majority"` to the
    client.

- A replica set with 3 voting members, Primary-Secondary-Arbiter (P-S-A)
  
  - The majority of all voting members is 2.

  - The number of all data-bearing voting members is 2.

  | The calculated majority is 2, the minimum of 2 and 2. Since the
    write can only be applied to data-bearing members, the write must
    propagate to the primary and the secondary to acknowledge the write
    concern :writeconcern:`"majority"` to the client.

  .. tip::

     Avoid using a :writeconcern:`"majority"` write concern with a
     (P-S-A) or other topologies that require all data-bearing voting
     members to be available to acknowledge the writes. Customers who
     want the durability guarantees of using a
     :writeconcern:`"majority"` write concern should instead deploy a
     topology that does not require all data bearing voting members to be
     available (e.g. P-S-S).
